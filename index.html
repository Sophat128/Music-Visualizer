<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="UTF-8">
        <title>js.nation</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/1.5.1/dexie.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/85/three.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrender/0.9.84/jsrender.min.js"></script>

        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
            ga('create', 'UA-101944034-1', 'auto');
            ga('send', 'pageview');
        </script>

        <script id="table-row-template" type="text/html">
            <tr class="song-row" data-songid="{{:id}}">
                <td class="db-song-control">
                    <div><a onclick="Database.handlePlay(`{{:id}}`)" class="fa fa-play interactable"></a></div>
                </td>
                <td class="row-art"><img width="50px" src="{{>img || './img/art_ph.png'}}"></td>
                <td class="row-title"><div>{{:title}}</div></td>
                <td class="row-artist"><div>{{:artist}}</div></td>
                <td><div>{{:duration}}</div></td>
                <td class="db-song-control">
                    <div><a onclick="Database.handleRemove(`{{:id}}`)" class="fa fa-trash interactable"></a></div>
                </td>
            </tr>
        </script>

        <link rel="stylesheet" type="text/css" href="./css/main.css?v=1.1">
        <link rel="stylesheet" type="text/css" href="./css/gui.css">
        <link rel="stylesheet" type="text/css" href="./css/custom.css">

        <script src="./js/audio/nodes.js"></script>
        <script src="./js/math/math_constants.js"></script>
        <script src="./js/math/transform.js"></script>
        <script src="./js/misc/callbacks.js"></script>
        <script src="./js/misc/config.js"></script>
        <script src="./js/misc/util.js"></script>
        <script src="./js/misc/database.js"></script>
        <script src="./js/misc/id3-minimized.js"></script>
        <script src="./js/misc/io_handler.js"></script>
        <script src="./js/model/particle_data.js"></script>
        <script src="./js/model/priority.js"></script>
        <script src="./js/model/song.js"></script>
        <script src="./js/visual/background.js"></script>
        <script src="./js/visual/drawn/canvas.js"></script>
        <script src="./js/visual/drawn/emblem.js"></script>
        <script src="./js/visual/drawn/spectrum.js"></script>
        <script src="./js/visual/gl/lighting.js"></script>
        <script src="./js/visual/gl/particles.js"></script>
        <script src="./js/visual/gl/renderer.js"></script>
        <script src="./js/visual/gl/scene.js"></script>
        <script src="./js/visual/gl/shaders.js"></script>
        <script src="./js/visual/gui/audio_wrap.js"></script>
        <script src="./js/visual/gui/gui_wrapper.js"></script>
        <script src="./js/main.js"></script>
    </head>
    <body>
        <div class="main-container">
            <div class="settings-panel">
                <div class="tabs">
                    <div class="tab active" data-tab="upload">Upload</div>
                    <div class="tab" data-tab="library">Library</div>
                    <div class="tab" data-tab="export">Export</div>
                </div>
                <div class="settings-content">
                    <div class="tab-content active" data-tab="upload">
                        <h2>Song, Background and Emblem</h2>
                        <div class="ui fluid action input inverted">
                            <input type="text" readonly value="Select Audio File">
                            <input accept="audio/*" type="file" id="settingsAudioFileSelector" style="display:none">
                            <label for="settingsAudioFileSelector" class="ui icon button interactable">
                                <i class="fa fa-music"></i> Audio
                            </label>
                        </div>
                        <div class="ui fluid action input inverted" style="margin-top: 10px;">
                            <input type="text" readonly value="Select Background Image">
                            <input accept="image/*" type="file" id="settingsBgImageSelector" style="display:none">
                            <label for="settingsBgImageSelector" class="ui icon button interactable">
                                <i class="fa fa-picture-o"></i> Background
                            </label>
                        </div>
                        <div class="ui fluid action input inverted" style="margin-top: 10px;">
                            <input type="text" readonly value="Select Emblem Image">
                            <input accept="image/*" type="file" id="settingsEmblemImageSelector" style="display:none">
                            <label for="settingsEmblemImageSelector" class="ui icon button interactable">
                                <i class="fa fa-star"></i> Emblem
                            </label>
                        </div>
                    </div>
                    <div class="tab-content" data-tab="library" style="display: none;">
                        <table class="ui selectable inverted table" id="db-view" border="1"></table>
                        <div id="db-page-info"></div>
                        <div id="db-input">
                            <div class="ui input">
                                <input type="text" id="field-artist" placeholder="Artist">
                            </div>
                            <div class="ui input">
                                <input type="text" id="field-title" placeholder="Title">
                            </div>
                        </div>
                        <div id="db-controls">
                            <button class="ui button interactable" id="add2DB">Add To Library</button>
                            <button class="ui button interactable" id="viewDB">Refresh Library</button>
                            <button class="ui button interactable" id="delDB">Delete Library</button>
                        </div>
                    </div>
                    <div class="tab-content" data-tab="export" style="display: none;">
                        <h2>Export Settings</h2>
                        <p>Customize how your final video will be recorded and rendered.</p>

                        <div class="ui form inverted">
                            <div class="field">
                                <label>Resolution</label>
                                <div class="ui selection dropdown">
                                    <input type="hidden" name="resolution" value="1080p">
                                    <i class="dropdown icon"></i>
                                    <div class="default text">1080p for standard HD quality</div>
                                    <div class="menu">
                                        <div class="item" data-value="720p">720p for faster export and smaller files</div>
                                        <div class="item" data-value="1080p">1080p for standard HD quality</div>
                                    </div>
                                </div>
                            </div>

                            <div class="field">
                                <label>Frame Rate (FPS)</label>
                                <div class="ui selection dropdown">
                                    <input type="hidden" name="fps" value="60">
                                    <i class="dropdown icon"></i>
                                    <div class="default text">60 FPS for smoother and more responsive visual effects</div>
                                    <div class="menu">
                                        <div class="item" data-value="30">30 FPS for standard motion</div>
                                        <div class="item" data-value="60">60 FPS for smoother and more responsive visual effects</div>
                                    </div>
                                </div>
                            </div>

                            <div class="field">
                                <label>Audio Quality</label>
                                <div class="ui selection dropdown">
                                    <input type="hidden" name="audio-quality" value="320kbps">
                                    <i class="dropdown icon"></i>
                                    <div class="default text">320 kbps MP3/AAC is recommended</div>
                                    <div class="menu">
                                        <div class="item" data-value="192kbps">192 kbps for good quality</div>
                                        <div class="item" data-value="320kbps">320 kbps for high-quality music playback</div>
                                    </div>
                                </div>
                            </div>

                            <div class="field">
                                <label>Format</label>
                                <div class="ui selection dropdown">
                                    <input type="hidden" name="format" value="mp4">
                                    <i class="dropdown icon"></i>
                                    <div class="default text">MP4</div>
                                    <div class="menu">
                                        <div class="item" data-value="mp4">MP4 (H.264 + AAC) offers the best compatibility</div>
                                        <div class="item" data-value="mov">MOV is suitable for professional editing</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="ui divider"></div>

                            <button class="ui button green" id="export-button">Export Video</button>
                            <div id="export-status" style="display: none; margin-top: 15px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="visualizer-container">
                <div class="aspect-ratio-container">
                    <div class="visual-preview">
                        <div id="background" class="lazyaf">
                            <img src="" class="bgleft" id="limg1" onerror="this.style.display='none'">
                            <img src="" class="bgright" id="limg2" onerror="this.style.display='none'">
                        </div>
                        <div id="background" class="realbg">
                            <img src="" class="bgleft" id="bgimg1" onload="Background.fadeFullRes(this)" onerror="this.style.display='none'">
                            <img src="" class="bgright" id="bgimg2" onload="Background.fadeFullRes(this)" onerror="this.style.display='none'">
                        </div>
                        <div id="content">
                            <canvas id="canvas" style="display: block;"></canvas>
                        </div>
                    </div>
                </div>
                <div class="video-control">
                    <div class="flex gui-part" id="gui-bottom">
                        <div class="flex" id="audio-player">  
                            <div class="flex main-controls">
                                <span id="previous" class="fa fa-step-backward interactable" onClick="Database.playPrevSong()"></span>
                                <span id="play" class="fa fa-pause action interactable"></span>
                                <span id="next" class="fa fa-step-forward action interactable" onClick="Database.playNextSong()"></span>
                                <span id="shuffle" class="fa fa-random action interactable" onClick="Database.toggleShuffle()"></span>
                            </div>
                            <span id="time" class="time">00:00</span>
                            <progress id="progressbar" class="flex-auto interactable" value="0" max="100"></progress>
                            <span id="mute" class="fa fa-volume-up interactable"></span>
                            <progress id="volume" class="flex-auto interactable" value="100" max="100"></progress>
                        </div>
                        <audio id="audio" onended="Database.playNextSong()"></audio>
                    </div>
                </div>
            </div>
        </div>

        <script>
        $(document).ready(function() {
            $('.tabs .tab').on('click', function() {
                var tabName = $(this).data('tab');
                $('.tabs .tab').removeClass('active');
                $('.settings-content .tab-content').hide();
                $(this).addClass('active');
                $('.settings-content .tab-content[data-tab="'+tabName+'"]').show();
            });

            $('.ui.dropdown').dropdown();

            // --- Automated MediaRecorder Logic ---
            let mediaRecorder;
            let recordedChunks = [];
            let isExporting = false;

            const exportBtn = $('#export-button');
            const statusDiv = $('#export-status');

            exportBtn.on('click', async function() {
                if (isExporting) return; // Prevent multiple clicks

                const audio = $('#audio')[0];
                if (!audio.src) {
                    statusDiv.text('Please load a song before exporting.').show();
                    return;
                }

                isExporting = true;
                exportBtn.addClass('loading disabled').text('Exporting...');
                statusDiv.text('Recording in progress. Please wait for the song to finish.').show();

                const canvas = $('#canvas')[0];
                const audioContext = Nodes.getContext();
                const source = Nodes.getMediaSource();

                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                const dest = audioContext.createMediaStreamDestination();
                source.connect(dest);
                
                const fps = parseInt($('[name="fps"]').val(), 10) || 30;
                const canvasStream = canvas.captureStream(fps);
                const combinedStream = new MediaStream([...canvasStream.getTracks(), ...dest.stream.getTracks()]);

                mediaRecorder = new MediaRecorder(combinedStream, { mimeType: 'video/webm' });
                recordedChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const formData = new FormData();
                    formData.append('video', blob, 'upload.webm');
                    formData.append('resolution', $('[name="resolution"]').val());
                    formData.append('fps', $('[name="fps"]').val());
                    formData.append('audioQuality', $('[name="audio-quality"]').val());
                    formData.append('format', $('[name="format"]').val());

                    statusDiv.text('Uploading and converting... This may take a moment.').show();

                    try {
                        const response = await fetch('http://localhost:8080/export-video', {
                            method: 'POST',
                            body: formData
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'Conversion failed.');
                        }

                        const fileBlob = await response.blob();
                        const downloadUrl = URL.createObjectURL(fileBlob);
                        const format = $('[name="format"]').val().toUpperCase();
                        statusDiv.html(`Conversion successful! <a href="${downloadUrl}" download="export.${format.toLowerCase()}" class="ui button compact primary">Download ${format}</a>`);

                    } catch (error) {
                        statusDiv.text('Error: ' + error.message).show();
                        console.error('Export failed:', error);
                    } finally {
                        isExporting = false;
                        exportBtn.removeClass('loading disabled').addClass('green').text('Export Video');
                        source.disconnect(dest);
                        // Restore the original onended behavior for playlists
                        audio.onended = function() { Database.playNextSong(); };
                    }
                };
                
                // --- Automation Magic ---
                // 1. Hijack the 'onended' event to stop the recording
                audio.onended = function() {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop(); // This will trigger the 'onstop' event handler above
                    }
                };

                // 2. Start the recorder
                mediaRecorder.start();

                // 3. Rewind and Play the audio
                audio.currentTime = 0;
                audio.play();
            });
        });
        </script>
    </body>
</html>